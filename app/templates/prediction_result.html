{% extends 'base.html' %}
{% block title %}Prediction Results - Genetic Disorder Prediction{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="content-wrapper fade-in">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4 fw-bold">
                    <i class="fas fa-chart-line"></i> Prediction Results
                </h1>
                <p class="lead text-muted">Analysis from {{ predictions|length }} AI Models</p>
            </div>
        </div>
        
        <!-- Ensemble Result -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card {% if ensemble_prediction == 1 %}border-danger{% else %}border-success{% endif %}" style="border-width: 3px;">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas {% if ensemble_prediction == 1 %}fa-exclamation-triangle text-danger{% else %}fa-check-circle text-success{% endif %}" 
                                   style="font-size: 5rem;"></i>
                            </div>
                            <div class="col-md-7">
                                <h2 class="mb-2">Ensemble Prediction</h2>
                                <h3 class="{% if ensemble_prediction == 1 %}text-danger{% else %}text-success{% endif %} mb-2">
                                    {% if ensemble_prediction == 1 %}
                                    <i class="fas fa-plus-circle"></i> POSITIVE for Genetic Disorder
                                    {% else %}
                                    <i class="fas fa-minus-circle"></i> NEGATIVE for Genetic Disorder
                                    {% endif %}
                                </h3>
                                <p class="lead mb-0">
                                    Confidence: <strong>{{ ensemble_confidence|floatformat:2 }}%</strong>
                                </p>
                                <p class="text-muted mt-2">
                                    Combined result from {{ predictions|length }} machine learning and deep learning models
                                </p>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar {% if ensemble_prediction == 1 %}bg-danger{% else %}bg-success{% endif %}" 
                                         style="width: {{ ensemble_confidence }}%;">
                                        {{ ensemble_confidence|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Individual Model Predictions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-brain"></i> Individual Model Predictions</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Model Name</th>
                                        <th>Prediction</th>
                                        <th>Confidence</th>
                                        <th>Confidence Bar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for model_name, result in predictions.items %}
                                    <tr>
                                        <td><strong>{{ model_name }}</strong></td>
                                        <td>
                                            {% if result.prediction == 1 %}
                                            <span class="badge bg-danger">POSITIVE</span>
                                            {% else %}
                                            <span class="badge bg-success">NEGATIVE</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ result.confidence|floatformat:2 }}%</strong></td>
                                        <td>
                                            <div class="progress" style="height: 25px; min-width: 200px;">
                                                <div class="progress-bar {% if result.prediction == 1 %}bg-danger{% else %}bg-success{% endif %}" 
                                                     style="width: {{ result.confidence }}%;">
                                                    {{ result.confidence|floatformat:1 }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Visualization Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Prediction Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Confidence Levels</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Data Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-database"></i> Input Data Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Gene Expression Values:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Gene 1:</strong> {{ input_data.gene_1 }}</li>
                                    <li><strong>Gene 2:</strong> {{ input_data.gene_2 }}</li>
                                    <li><strong>Gene 3:</strong> {{ input_data.gene_3 }}</li>
                                    <li><strong>Gene 4:</strong> {{ input_data.gene_4 }}</li>
                                    <li><strong>Gene 5:</strong> {{ input_data.gene_5 }}</li>
                                    <li><strong>Gene 6:</strong> {{ input_data.gene_6 }}</li>
                                    <li><strong>Gene 7:</strong> {{ input_data.gene_7 }}</li>
                                    <li><strong>Gene 8:</strong> {{ input_data.gene_8 }}</li>
                                    <li><strong>Gene 9:</strong> {{ input_data.gene_9 }}</li>
                                    <li><strong>Gene 10:</strong> {{ input_data.gene_10 }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">SNPs & Clinical Data:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>SNP 1:</strong> {{ input_data.snp_1 }}</li>
                                    <li><strong>SNP 2:</strong> {{ input_data.snp_2 }}</li>
                                    <li><strong>SNP 3:</strong> {{ input_data.snp_3 }}</li>
                                    <li><strong>SNP 4:</strong> {{ input_data.snp_4 }}</li>
                                    <li><strong>SNP 5:</strong> {{ input_data.snp_5 }}</li>
                                    <li><strong>Age:</strong> {{ input_data.age }} years</li>
                                    <li><strong>BMI:</strong> {{ input_data.bmi }}</li>
                                    <li><strong>Smoking Status:</strong> {% if input_data.smoking_status == 1 %}Smoker{% else %}Non-Smoker{% endif %}</li>
                                    <li><strong>Protein Similarity:</strong> {{ input_data.protein_similarity }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="row">
            <div class="col-12 text-center">
                <a href="{% url 'predict' %}" class="btn btn-primary btn-lg px-5 me-3">
                    <i class="fas fa-redo"></i> New Prediction
                </a>
                <a href="{% url 'prediction_history' %}" class="btn btn-outline-info btn-lg px-5 me-3">
                    <i class="fas fa-history"></i> View History
                </a>
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg px-5">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Prepare data for charts
const predictions = {{ predictions|safe|escapejs }};
const modelsData = Object.entries(predictions);

// Prediction Distribution Chart
const ctxPrediction = document.getElementById('predictionChart').getContext('2d');
const positiveCount = modelsData.filter(([_, data]) => data.prediction === 1).length;
const negativeCount = modelsData.filter(([_, data]) => data.prediction === 0).length;

new Chart(ctxPrediction, {
    type: 'bar',
    data: {
        labels: modelsData.map(([name, _]) => name),
        datasets: [{
            label: 'Prediction (0=Negative, 1=Positive)',
            data: modelsData.map(([_, data]) => data.prediction),
            backgroundColor: modelsData.map(([_, data]) => 
                data.prediction === 1 ? 'rgba(231, 76, 60, 0.7)' : 'rgba(80, 200, 120, 0.7)'
            ),
            borderColor: modelsData.map(([_, data]) => 
                data.prediction === 1 ? 'rgba(231, 76, 60, 1)' : 'rgba(80, 200, 120, 1)'
            ),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 1,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: true
            },
            title: {
                display: true,
                text: `Positive: ${positiveCount} | Negative: ${negativeCount}`
            }
        }
    }
});

// Confidence Levels Chart
const ctxConfidence = document.getElementById('confidenceChart').getContext('2d');
new Chart(ctxConfidence, {
    type: 'radar',
    data: {
        labels: modelsData.map(([name, _]) => name),
        datasets: [{
            label: 'Confidence (%)',
            data: modelsData.map(([_, data]) => data.confidence),
            fill: true,
            backgroundColor: 'rgba(102, 126, 234, 0.2)',
            borderColor: 'rgb(102, 126, 234)',
            pointBackgroundColor: 'rgb(102, 126, 234)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(102, 126, 234)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                display: true
            }
        }
    }
});
</script>

{% endblock %}
